name: Extension AI Analysis

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ai-analysis:
    runs-on: ubuntu-latest
    environment: ai-analysis # ðŸ‘ˆ requires approval from slicer-developer to avoid exposing secret (API key)
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 30
    steps:
      - name: Checkout the fork PR code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0 # Fetch full history for git diff

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: scripts/requirements.txt

      - name: Configure git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          echo "Installing dependencies from requirements.txt:"
          cat scripts/requirements.txt
          pip install -r scripts/requirements.txt
          echo "Verifying installed packages:"
          pip list | grep -E "(jsonschema|requests)"

      - name: Get changed files
        run: |
          mkdir -p /tmp/ai-analysis-reports
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch origin $BASE_REF
          echo "Base ref: $BASE_REF"
          # List only Added (A) or Modified (M) JSON files
          git diff --name-only --diff-filter=AM "origin/$BASE_REF"...HEAD \
            | grep '\.json$' > /tmp/ai-analysis-reports/changed_files.txt 2>/dev/null
          echo "Changed JSON files:"
          cat /tmp/ai-analysis-reports/changed_files.txt

      - name: Run AI analysis
        env:
          NEBULA_API_KEY: ${{ secrets.NEBULA_API_KEY }}
        id: ai-analysis
        run: |
          python scripts/extension_ai_analysis.py \
            $(cat /tmp/ai-analysis-reports/changed_files.txt | tr '\n' ' ')
