name: Extension AI Analysis

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ai-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 30
    steps:
      - name: Checkout the fork PR code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0 # Fetch full history for git diff

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: scripts/requirements.txt

      - name: Configure git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          echo "Installing dependencies from requirements.txt:"
          cat scripts/requirements.txt
          pip install -r scripts/requirements.txt
          echo "Verifying installed packages:"
          pip list | grep -E "(jsonschema|requests)"

      - name: Get changed files
        run: |
          mkdir -p /tmp/ai-analysis-reports

          # Upstream repo (base repository)
          UPSTREAM_REPO="${{ github.event.pull_request.base.repo.full_name }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          echo "Upstream repo: $UPSTREAM_REPO"
          echo "Base ref: $BASE_REF"

          # Add upstream remote and fetch latest base branch
          git remote add upstream "https://github.com/$UPSTREAM_REPO.git"
          git fetch upstream $BASE_REF

          # Checkout PR code
          git checkout ${{ github.event.pull_request.head.ref }}

          # Diff fork PR vs upstream base branch
          git diff --name-only --diff-filter=AM upstream/$BASE_REF...HEAD \
            | grep -E '\.json$' > /tmp/ai-analysis-reports/changed_files.txt || true

          echo "Changed JSON files:"
          cat /tmp/ai-analysis-reports/changed_files.txt || echo "(none)"

      - name: Run AI analysis
        env:
          NEBULA_API_KEY: ${{ secrets.NEBULA_API_KEY }}
        id: ai-analysis
        run: |
          RESULT=$(python scripts/extension_ai_analysis.py \
            $(cat /tmp/ai-analysis-reports/changed_files.txt | tr '\n' ' '))
          echo "$RESULT"
          # Append result to GitHub Actions job summary
          echo "### AI Analysis Result" >> $GITHUB_STEP_SUMMARY
          echo "$RESULT" >> $GITHUB_STEP_SUMMARY
