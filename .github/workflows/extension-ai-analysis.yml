name: Extension AI Analysis

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main
      - 5.*

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ai-analysis:
    runs-on: ubuntu-latest
    environment: ai-analysis # ðŸ‘ˆ requires approval from slicer-developer to avoid exposing secret (API key)
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0 # Fetch full history for git diff

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: scripts/requirements.txt

      - name: Configure git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          echo "Installing dependencies from requirements.txt:"
          cat scripts/requirements.txt
          pip install -r scripts/requirements.txt
          echo "Verifying installed packages:"
          pip list | grep -E "(jsonschema|requests)"

      - name: Get changed files
        run: |
          echo "Event: ${{ github.event_name }}"
          mkdir -p /tmp/ai-analysis-reports
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For pull requests, compare against the base branch
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            echo "Base ref: $BASE_REF"
            git diff --name-only "origin/$BASE_REF"...HEAD > /tmp/ai-analysis-reports/changed_files.txt 2>/dev/null
          else
            # For pushes, compare against the previous commit or get all JSON files if it's the first commit
            git diff --name-only HEAD~1 HEAD > /tmp/ai-analysis-reports/changed_files.txt 2>/dev/null
          fi
          echo "Changed JSON files:"
          cat /tmp/ai-analysis-reports/changed_files.txt

      - name: Run AI analysis
        env:
          NEBULA_API_KEY: ${{ secrets.NEBULA_API_KEY }}
        id: ai-analysis
        run: |
          python scripts/extension_ai_analysis.py \
            $(cat /tmp/ai-analysis-reports/changed_files.txt | tr '\n' ' ')
